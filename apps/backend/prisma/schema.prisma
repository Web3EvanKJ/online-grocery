generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  user
  store_admin
  super_admin
}

enum StockType {
  in
  out
}

enum DiscountType {
  product
  store
  b1g1
}

enum DiscountInputType {
  percentage
  nominal
}

enum VoucherType {
  product
  total
  shipping
}

enum VoucherDiscountType {
  percentage
  nominal
}

enum PaymentMethod {
  manual_transfer
  payment_gateway
}

enum OrderStatus {
  Menunggu_Pembayaran
  Menunggu_Konfirmasi_Pembayaran
  Diproses
  Dikirim
  Pesanan_Dikonfirmasi
  Dibatalkan
}

model users {
  id            Int       @id @default(autoincrement())
  name          String
  email         String    @unique
  password      String? // null until user verifies or social login
  phone         String?
  role          Role
  is_verified   Boolean   @default(false)
  profile_image String?
  referral_code String?
  referred_by   String?
  created_at    DateTime? @default(now())
  updated_at    DateTime? @updatedAt

  // Relations
  store_admins      store_admins[]
  addresses         addresses[]
  user_vouchers     user_vouchers[]
  orders            orders[]
  payments_verified payments[]      @relation("VerifiedPayments")
  carts             carts[]
}

model stores {
  id         Int       @id @default(autoincrement())
  name       String
  address    String
  province   String
  city       String
  district   String
  latitude   Decimal
  longitude  Decimal
  created_at DateTime? @default(now())
  updated_at DateTime? @updatedAt

  // Relations
  store_admins store_admins[]
  inventories  inventories[]
  discounts    discounts[]
  orders       orders[]
}

model store_admins {
  id          Int       @id @default(autoincrement())
  user_id     Int       @unique
  store_id    Int       @unique
  assigned_at DateTime? @default(now())

  user  users  @relation(fields: [user_id], references: [id])
  store stores @relation(fields: [store_id], references: [id])
}

model categories {
  id         Int       @id @default(autoincrement())
  name       String
  created_at DateTime? @default(now())
  updated_at DateTime? @updatedAt

  products products[]
}

model products {
  id          Int       @id @default(autoincrement())
  category_id Int
  name        String
  slug        String    @unique
  description String?
  price       Decimal
  created_at  DateTime? @default(now())
  updated_at  DateTime? @updatedAt

  category    categories       @relation(fields: [category_id], references: [id])
  images      product_images[]
  inventories inventories[]
  discounts   discounts[]
  vouchers    vouchers[]
  order_items order_items[]
  carts       carts[]
}

model product_images {
  id         Int    @id @default(autoincrement())
  product_id Int
  image_url  String

  product products @relation(fields: [product_id], references: [id])
}

model inventories {
  id         Int       @id @default(autoincrement())
  product_id Int
  store_id   Int
  stock      Int
  updated_at DateTime? @updatedAt

  product  products         @relation(fields: [product_id], references: [id])
  store    stores           @relation(fields: [store_id], references: [id])
  journals stock_journals[]

  @@unique([product_id, store_id])
}

model stock_journals {
  id           Int       @id @default(autoincrement())
  inventory_id Int
  type         StockType
  quantity     Int
  note         String?
  created_at   DateTime? @default(now())

  inventory inventories @relation(fields: [inventory_id], references: [id])
}

model discounts {
  id           Int               @id @default(autoincrement())
  store_id     Int
  product_id   Int?
  type         DiscountType
  inputType    DiscountInputType
  value        Decimal
  min_purchase Decimal?
  max_discount Decimal?
  start_date   DateTime
  end_date     DateTime
  created_at   DateTime?         @default(now())
  updated_at   DateTime?         @updatedAt

  store   stores    @relation(fields: [store_id], references: [id])
  product products? @relation(fields: [product_id], references: [id])
}

model vouchers {
  id             Int                 @id @default(autoincrement())
  code           String              @unique
  type           VoucherType
  discount_type  VoucherDiscountType
  discount_value Decimal
  max_discount   Decimal?
  product_id     Int?
  expired_at     DateTime?
  created_at     DateTime?           @default(now())

  product       products?       @relation(fields: [product_id], references: [id])
  user_vouchers user_vouchers[]
  orders        orders[]
}

model user_vouchers {
  id          Int       @id @default(autoincrement())
  user_id     Int
  voucher_id  Int
  is_used     Boolean   @default(false)
  assigned_at DateTime? @default(now())

  user    users    @relation(fields: [user_id], references: [id])
  voucher vouchers @relation(fields: [voucher_id], references: [id])
}

model addresses {
  id             Int       @id @default(autoincrement())
  user_id        Int
  label          String
  address_detail String
  province       String
  city           String
  district       String
  subdistrict    String
  latitude       Decimal
  longitude      Decimal
  is_main        Boolean   @default(false)
  created_at     DateTime? @default(now())
  updated_at     DateTime? @updatedAt

  user   users    @relation(fields: [user_id], references: [id])
  orders orders[]
}

model shipping_methods {
  id          Int     @id @default(autoincrement())
  name        String
  provider    String
  base_cost   Decimal
  cost_per_km Decimal

  orders orders[]
}

model orders {
  id                 Int         @id @default(autoincrement())
  user_id            Int
  store_id           Int
  address_id         Int
  voucher_id         Int?
  shipping_method_id Int
  total_amount       Decimal
  shipping_cost      Decimal
  discount_amount    Decimal?
  status             OrderStatus
  created_at         DateTime?   @default(now())
  updated_at         DateTime?   @updatedAt

  user            users            @relation(fields: [user_id], references: [id])
  store           stores           @relation(fields: [store_id], references: [id])
  address         addresses        @relation(fields: [address_id], references: [id])
  voucher         vouchers?        @relation(fields: [voucher_id], references: [id])
  shipping_method shipping_methods @relation(fields: [shipping_method_id], references: [id])
  order_items     order_items[]
  payments        payments[]
}

model order_items {
  id         Int      @id @default(autoincrement())
  order_id   Int
  product_id Int
  quantity   Int
  price      Decimal
  discount   Decimal?

  order   orders   @relation(fields: [order_id], references: [id])
  product products @relation(fields: [product_id], references: [id])
}

model payments {
  id          Int           @id @default(autoincrement())
  order_id    Int
  method      PaymentMethod
  proof_image String?
  transaction_id String?
  is_verified Boolean       @default(false)
  verified_by Int?
  created_at  DateTime?     @default(now())
  updated_at  DateTime?     @updatedAt

  order         orders @relation(fields: [order_id], references: [id])
  verified_user users? @relation("VerifiedPayments", fields: [verified_by], references: [id])
}

model carts {
  id         Int       @id @default(autoincrement())
  user_id    Int
  product_id Int
  quantity   Int
  created_at DateTime? @default(now())
  updated_at DateTime? @updatedAt

  user    users    @relation(fields: [user_id], references: [id])
  product products @relation(fields: [product_id], references: [id])
}
